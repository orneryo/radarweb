<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Arduino Radar – Web Serial</title>

<style>
  :root{
    --bg:#001100;
    --fg:#00ff00;
    --grid:rgba(0,255,0,0.15);
    --fade:rgba(0,0,0,0.08);
  }
  body{
    margin:0;
    background:var(--bg);
    color:var(--fg);
    font-family:system-ui,Segoe UI,Roboto,Arial;
    height:100vh;
    display:flex;
    flex-direction:column;
    align-items:center;
  }
  h2{
    margin:10px 0 0;
  }
  .controls{
    margin-top:10px;
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    justify-content:center;
  }
  button,select{
    background:transparent;
    border:1px solid var(--fg);
    color:var(--fg);
    padding:6px 10px;
    border-radius:6px;
    font-size:1rem;
  }
  #status{
    margin-top:10px;
    font-size:0.9rem;
    opacity:0.9;
  }
  canvas{
    margin-top:10px;
    border-radius:8px;
    background:#000;
    max-width:95vw;
    height:auto;
    box-shadow:0 0 20px rgba(0,255,0,0.2);
  }
</style>
</head>

<body>

<h2>Arduino Radar – USB Web Serial</h2>

<div class="controls">
  <button id="connectBtn">Connect USB</button>
  <button id="disconnectBtn" disabled>Disconnect</button>

  <label>
    Baud:
    <select id="baud">
      <option>115200</option>
      <option>57600</option>
      <option>38400</option>
      <option>9600</option>
    </select>
  </label>
</div>

<div id="status">Not connected</div>

<canvas id="radar" width="600" height="600"></canvas>

<script>
/* ------------------------- Radar Web Serial Script ------------------------- */

const connectBtn = document.getElementById("connectBtn");
const disconnectBtn = document.getElementById("disconnectBtn");
const baudSelect = document.getElementById("baud");
const statusEl = document.getElementById("status");

let port = null;
let reader = null;
let keepReading = false;

const canvas = document.getElementById("radar");
const ctx = canvas.getContext("2d", {alpha:false});
const W = canvas.width;
const H = canvas.height;
const cx = W/2;
const cy = H/2;

const maxRangeCm = 400;
const maxPx = Math.min(W,H)/2 - 15;

function drawBackground(){
  ctx.fillStyle = "#001100";
  ctx.fillRect(0,0,W,H);
  ctx.strokeStyle = "rgba(0,255,0,0.2)";
  for(let i=1;i<=4;i++){
    ctx.beginPath();
    ctx.ellipse(cx,cy,(maxPx*i/4),(maxPx*i/4),0,0,Math.PI*2);
    ctx.stroke();
  }
  ctx.strokeStyle = "rgba(0,255,0,0.5)";
  ctx.beginPath(); ctx.moveTo(cx,0); ctx.lineTo(cx,H); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(0,cy); ctx.lineTo(W,cy); ctx.stroke();
}
drawBackground();

function fadeCanvas(){
  ctx.fillStyle = "rgba(0,0,0,0.06)";
  ctx.fillRect(0,0,W,H);
}

async function readLoop(){
  const decoder = new TextDecoderStream();
  const closed = port.readable.pipeTo(decoder.writable);
  const stream = decoder.readable.getReader();
  keepReading = true;

  let buf = "";

  while(keepReading){
    const {value,done} = await stream.read();
    if(done) break;
    if(value){
      buf += value;
      let lines = buf.split(/\r?\n/);
      buf = lines.pop();
      for(const line of lines){
        handleLine(line.trim());
      }
    }
  }

  stream.releaseLock();
}

function handleLine(line){
  if(!line) return;
  const parts = line.split(",");
  if(parts.length < 2) return;

  const angle = parseFloat(parts[0]);
  const dist = parseFloat(parts[1]);
  if(!(isFinite(angle) && isFinite(dist))) return;
  if(dist <= 0) return;

  fadeCanvas();

  const r = Math.min(maxPx, (dist/maxRangeCm)*maxPx);
  const t = (angle - 90) * Math.PI/180;
  const x = cx + r * Math.cos(t);
  const y = cy + r * Math.sin(t);

  ctx.fillStyle = "rgba(0,255,0,1)";
  ctx.beginPath();
  ctx.arc(x,y,5,0,Math.PI*2);
  ctx.fill();

  ctx.strokeStyle = "rgba(0,255,0,0.1)";
  ctx.beginPath();
  ctx.moveTo(cx,cy);
  ctx.lineTo(x,y);
  ctx.stroke();

  statusEl.textContent = `Angle ${angle}°, Distance ${dist} cm`;
}

connectBtn.onclick = async () => {
  if(!("serial" in navigator)){
    alert("Web Serial API not supported. Use Chrome on Android or Chrome desktop.");
    return;
  }
  try{
    port = await navigator.serial.requestPort();
    await port.open({baudRate:Number(baudSelect.value)});
    statusEl.textContent = "Connected";
    connectBtn.disabled = true;
    disconnectBtn.disabled = false;
    readLoop();
  }catch(err){
    console.error(err);
    statusEl.textContent = "Connection failed";
  }
};

disconnectBtn.onclick = async () => {
  keepReading = false;
  try{
    await reader?.cancel();
    await port?.close();
  }catch(e){}
  connectBtn.disabled = false;
  disconnectBtn.disabled = true;
  statusEl.textContent = "Disconnected";
};

</script>
</body>
</html>
